# キーボード配列最適化 - 数理モデル v2

## 概要

モデルv2は、**複数レイヤー・アルファベット固定**での最適化を扱います。v1の全機能を継承し、レイヤ機能（同時押し）を追加して記号の効率的配置を実現します。アルファベット（A-Z）は固定位置に維持し、レイヤ機能により複雑な記号配列を可能にします。

**主要特徴**:
- v1の全機能（指別Fitts係数、方向依存幅、連結クラスタ）
- レイヤ機能による同時押し記号配置
- 同時押し時間の精密モデル（並行係数、ペナルティ）
- 物理配置とレイヤ割当の分離設計
- 完全線形化による高速解法

## 1. v2で追加される要素

v1の全機能を継承し、レイヤ機能を追加。

### 1.1 レイヤ関連集合

- **レイヤ集合**: $L = \{0, 1, 2, \ldots\}$ (0=ベースレイヤ)
- **レイヤ記号**: $S$ (同時押しで出すシンボル、v2以降)
- **モディファイアアンカー**: $\tilde{M} \subset \mathcal{U}_g$ (親指行等の1uブロック)

### 1.2 同時押し時間（事前計算で定数化）

アンカー $m$、キー $u$、並行係数 $\theta_{F(u),F(m)}$、ペナルティ $\tau_{\mathrm{mod}}$：
$$T^{\mathrm{chord}}(u,m) = T_{\mathrm{tap}}(u) + T_{\mathrm{tap}}(m) - \theta_{F(u),F(m)} \min\{T_{\mathrm{tap}}(u), T_{\mathrm{tap}}(m)\} + \tau_{\mathrm{mod}}$$

パラメータ：
- $\theta_{f,f'}$: 並行係数（異手: 0.9, 同手: 0.4）
- $\tau_{\mathrm{mod}}$: モディファイア押下/解放ペナルティ（10ms）

### 1.3 v2で追加される決定変数

**レイヤ配置**:
$$q_{l,m} \in \{0,1\} \quad (l \geq 1, m \in \tilde{M})$$
$$z_{s,l,u,m} \in \{0,1\} \quad (s \in S, l \geq 1, u \in \mathcal{U}_g, m \in \tilde{M})$$

> **重要**: 物理配置 $x$ はレイヤ非依存。レイヤは論理割当 $z$ のみが層ごとに変化。

- $q_{l,m} = 1$: レイヤ$l$でアンカー$m$を使用
- $z_{s,l,u,m} = 1$: 記号$s$をレイヤ$l$でブロック$u$とアンカー$m$の同時押しに配置

## 2. v2の目的関数

v1の目的関数 + レイヤ項：
$$\min \left[
\text{(v1の目的関数)}
+ \gamma \sum_{s \in S} \sum_{l \geq 1} \sum_{u,m} f_s T^{\mathrm{chord}}(u,m) z_{s,l,u,m}
\right]$$

詳細：
$$\min \left[
\alpha \sum_{k \in K} \sum_{j,w} f_k T^{(k)}_{j,w} x_{k,j,w}
+ \beta \sum_{d \in A} \sum_{u} f_d T_{\mathrm{tap}}(u) m^A_{d,u}
+ \beta \sum_{d \in N} \sum_{u} f_d T_{\mathrm{tap}}(u) m^N_{d,u}
+ \gamma \sum_{s \in S} \sum_{l \geq 1} \sum_{u,m} f_s T^{\mathrm{chord}}(u,m) z_{s,l,u,m}
+ \lambda_w \sum_{k,j,w} w x_{k,j,w}
\right]$$

## 3. v2で追加される制約

### 3.1 レイヤ制約

**モディファイア一意性**:
$$\sum_{m \in \tilde{M}} q_{l,m} \leq 1 \quad \forall l \geq 1$$

**レイヤ配置の整合性**:
$$z_{s,l,u,m} \leq q_{l,m} \quad \forall s \in S, l \geq 1, u \in \mathcal{U}_g, m \in \tilde{M}$$

**記号の配置一意性**（ベース or どこか1レイヤ）:
$$\sum_{j,w} x_{s,j,w} + \sum_{l \geq 1} \sum_{u,m} z_{s,l,u,m} = 1 \quad \forall s \in S$$

### 3.2 物理非重複制約（v1を拡張）

レイヤ $z$ は物理占有しないため、v1と同じ制約。
ただし、アンカーを共用領域に置く場合は追加項が必要。

## 4. v2の完全な定式化

### 4.1 目的関数（v1を拡張）
$$\min \left[
\alpha \sum_{k \in K} \sum_{j,w} f_k T^{(k)}_{j,w} x_{k,j,w}
+ \beta \sum_{d \in A} \sum_{u} f_d T_{\mathrm{tap}}(u) m^A_{d,u}
+ \beta \sum_{d \in N} \sum_{u} f_d T_{\mathrm{tap}}(u) m^N_{d,u}
+ \gamma \sum_{s \in S} \sum_{l \geq 1} \sum_{u,m} f_s T^{\mathrm{chord}}(u,m) z_{s,l,u,m}
+ \lambda_w \sum_{k,j,w} w x_{k,j,w}
\right]$$

### 4.2 制約条件

#### v1のすべての制約 + 以下のレイヤ制約

#### (6) レイヤ制約

**モディファイア一意性**:
$$\sum_{m \in \tilde{M}} q_{l,m} \leq 1 \quad \forall l \geq 1$$

**レイヤ配置の整合性**:
$$z_{s,l,u,m} \leq q_{l,m} \quad \forall s \in S, l \geq 1, u \in \mathcal{U}_g, m \in \tilde{M}$$

**記号の配置一意性**:
$$\sum_{j \in \mathcal{I}_s^g} \sum_{w \in W_s} x_{s,j,w} + \sum_{l \geq 1} \sum_{u,m} z_{s,l,u,m} = 1 \quad \forall s \in S$$

#### (7) 追加変数の定義域
$$q_{l,m} \in \{0,1\} \quad \forall l \geq 1, m \in \tilde{M}$$
$$z_{s,l,u,m} \in \{0,1\} \quad \forall s \in S, l \geq 1, u \in \mathcal{U}_g, m \in \tilde{M}$$

## 5. 問題の複雑性

### 5.1 変数数の計算

**v1から継承**:
- 通常キー: $|K| \times |\mathcal{I}^g| \times |W|$
- 矢印・数字クラスタ: $(18 + 2|E_g|)|\mathcal{U}_g|$

**v2追加分**:
- レイヤ変数: $|\tilde{M}|(L-1) + |S|(L-1)|\mathcal{U}_g||\tilde{M}|$

### 5.2 制約数の計算

**v1から継承**:
- 一意性・個数: $|K| + 14$
- 物理制約: $|J_g|$
- 連結制約: $4|\mathcal{U}_g| + 4 + 4|E_g|$

**v2追加分**:
- レイヤ制約: $(L-1) + |S|(L-1)|\mathcal{U}_g||\tilde{M}| + |S|$

### 5.3 問題クラス

**混合整数線形計画問題（MILP）**であり、CBCなどのオープンソースソルバーで解くことができます。

## 6. パラメータ設定例

### 6.1 物理パラメータ（v1と同様）

- $s_{\mathrm{u2mm}} = 19$ mm/u
- 端狙い補正: $\eta = 0$ (必要に応じて0.25-0.5)

### 6.2 指別Fittsパラメータ（v1と同様）

- 人差し指: $a = 40$ms, $b = 120$ms
- 中指: $a = 45$ms, $b = 130$ms  
- 薬指: $a = 55$ms, $b = 145$ms
- 小指: $a = 65$ms, $b = 160$ms
- 親指: $a = 50$ms, $b = 140$ms

### 6.3 同時押しパラメータ（v2新規）

- 異手並行係数: $\theta = 0.9$
- 同手並行係数: $\theta = 0.4$
- モディファイアペナルティ: $\tau_{\mathrm{mod}} = 10$ms

### 6.4 最適化重み

- 通常キー重み: $\alpha = 1.0$
- クラスタ重み: $\beta = 1.0$
- レイヤ重み: $\gamma = 1.0$（v2新規）
- 幅正則化: $\lambda_w = 0.01$

## 7. 計算複雑性と解法

### 7.1 推奨ソルバー

**オープンソース**:
- CBC (COIN-OR)
- SCIP

**商用**:
- Gurobi
- CPLEX

### 7.2 解法戦略

1. **段階的最適化**: v1結果をv2の初期解として利用
2. **分解手法**: 物理配置とレイヤ割当の分離最適化
3. **ヒューリスティック**: 貪欲法による初期解生成

## 8. モデルv2の特徴

### 8.1 v1からの主要拡張

1. **レイヤ機能**: 同時押しによる記号の効率的配置
2. **同時押しモデル**: 並行係数とペナルティを考慮した精密な時間計算
3. **物理・論理分離**: 物理配置とレイヤ割当の独立最適化
4. **拡張性**: 新しいレイヤの追加が容易
5. **実用性**: 現代的なキーボードレイアウトのニーズに対応

### 8.2 設計思想

- **v1継承**: すべてのv1機能を完全継承
- **レイヤ拡張**: 物理制約を変更せずにレイヤ機能を追加
- **モジュール化**: レイヤごとの独立した論理割当
- **実装指向**: CBCソルバーでの実行を想定した設計

## 9. まとめ

モデルv2は、複数レイヤーでのキーボード配列最適化のための包括的な数理モデルです。v1の全機能を継承しながら、レイヤ機能による同時押し記号配置を実現し、現代的なキーボードレイアウトの要求に応えます。物理配置とレイヤ割当の分離設計により、拡張性と実用性を両立し、CBCなどのオープンソースソルバーで効率的に解くことができます。