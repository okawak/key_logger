# キーボード配列最適化 - 数理モデル文書

## 概要

このディレクトリには、キーボード配列最適化のための数理モデルの詳細な文書が含まれています。Fittsの法則に基づく混合整数線形計画問題として定式化された段階的なモデルバージョンを提供しています。

## モデル一覧

### [v1.md](./v1.md) - 単一レイヤー・アルファベット固定
**対象**: 記号キー・矢印・数字の配置最適化

**主要機能**:
- アルファベット（A-Z）は固定位置（QWERTY等）
- ベースレイヤのみ（同時押し無し）
- 指別Fitts係数による精密なタイピング時間モデル
- 方向依存の有効幅計算（楕円近似）
- 矢印キーと数字キーの連結クラスタ
- 前計算による完全線形化

**適用場面**:
- シンプルなキーボード配列の設計
- レイヤ機能を必要としない場合
- v2への基盤となる基本モデル理解

### [v2.md](./v2.md) - 複数レイヤー・アルファベット固定（推奨）
**対象**: v1 + レイヤ機能（同時押し）

**主要機能**:
- v1のすべての機能
- レイヤ機能による記号の効率的配置
- 同時押し時間の精密モデル（並行係数、ペナルティ）
- 物理配置とレイヤ割当の分離設計
- 現代的なキーボードレイアウト対応

**適用場面**:
- 実用的なキーボード配列を作成したい
- レイヤ機能を活用したい
- 記号キーの効率的配置が必要
- 商用キーボードの配列設計

### v3 - 複数レイヤー・アルファベット自由（将来拡張）
**対象**: 全キーの配置最適化

**計画機能**:
- v2のすべての機能
- アルファベットも最適化対象に含む
- 完全な配列最適化
- 学習コスト制約（既存配列からの距離ペナルティ）

## モデルの段階的発展

| 項目 | v1 | v2 | v3（将来） |
|------|----|----|-----------|
| **対象キー** | 記号・矢印・数字 | v1 + レイヤ記号 | v2 + アルファベット |
| **アルファベット** | 固定（QWERTY等） | 固定 | 最適化対象 |
| **レイヤ** | なし（単一） | 複数（同時押し） | 複数 |
| **Fitts係数** | 指別対応 | 指別対応 | 指別対応 |
| **連結クラスタ** | 矢印・数字 | 矢印・数字 | 矢印・数字 |
| **制約複雑度** | 基本 | 基本 + レイヤ | 基本 + レイヤ + α |
| **実装状況** | 実装予定 | 実装予定 | 将来検討 |

## モデルの選択指針

### v1を選ぶべき場合
- 学習・研究目的でシンプルなモデルから始めたい
- レイヤ機能を必要としない
- 段階的にv2へ発展させる基盤として
- 基本的な概念を理解したい

### v2を選ぶべき場合（推奨）
- 実用的なキーボード配列を作成したい
- レイヤ機能を活用したい
- 現代的なキーボードレイアウトのニーズに対応したい
- 最大限の機能を活用したい

### v3について（将来）
- アルファベット配置も含めた完全最適化
- 既存配列からの移行コストを考慮
- 研究・実験目的での完全自由度

## 共通する特徴

### 数理的基盤
- **Fittsの法則**: 移動時間 = a + b log₂(距離/幅 + 1)
- **整数線形計画**: 離散的な配置決定問題として定式化
- **制約満足**: 物理的制約と設計制約の両立

### 最適化目標
- **主目標**: タイピング時間の最小化
- **副目標**: 使用頻度に基づく効率的配置
- **制約**: 物理的配置制約、連結性制約

### 対応配列
- **Row-staggered**: 従来のQWERTY形状
- **Column-staggered**: 列ごとに段差をつけた形状  
- **Ortholinear**: 格子状配列

## 実装について

### 必要なソルバー
- **オープンソース**: CBC (COIN-OR), SCIP
- **商用**: Gurobi, CPLEX

### パラメータ設定
各モデルの文書内で詳細なパラメータ例を提供しています：
- 指別Fittsパラメータ（v1・v2共通）
- 同時押しパラメータ（v2）
- 幾何学的パラメータ
- 最適化重み

### 入力データ
- **キー使用頻度**: 実際のタイピングログから算出
- **座標情報**: 各配列タイプの幾何学的定義
- **制約設定**: 固定キーの位置、配置制限

## モデル間の関係

### 段階的発展
1. **v1**: 単一レイヤーでの最適化基盤
2. **v2**: v1の完全継承 + レイヤ機能拡張
3. **v3**: v2の完全継承 + アルファベット最適化

### 技術継承
- **v1→v2**: すべての機能を継承し、レイヤを追加
- **v2→v3**: すべての機能を継承し、アルファベット最適化を追加
- **設計思想**: 下位互換性を保ちつつ段階的に機能拡張

## 実装状況

### v2レイヤー機能の実装状況

#### 実装済み機能

**1. レイヤシステム (layers.rs)**
- LayerConfig: v2レイヤシステムの設定管理
- 同時押し時間計算: $T^{\mathrm{chord}}(u,m) = T_{\mathrm{tap}}(u) + T_{\mathrm{tap}}(m) - \theta_{F(u),F(m)} \min\{T_{\mathrm{tap}}(u), T_{\mathrm{tap}}(m)\} + \tau_{\mathrm{mod}}$
- レイヤ制約生成: モディファイア一意性、配置整合性、記号配置一意性制約

**2. v2統合ソルバー (solver.rs)**
- Phase 1+2: 基本最適化（v1継承）✓
- Phase 3: レイヤ機能（同時押し）✓
- 決定変数: $x_{k,j,w}$（通常）, $q_{l,m}$（レイヤ）, $z_{s,l,u,m}$（記号配置）

**3. 可視化機能**
- レイヤー別表示（ベース + 各レイヤー縦並び）
- レイヤー専用キーのハイライト
- 空白キー表示（未割り当て位置の明示）

#### 動作確認結果

**テスト設定**: Row-staggered, 5行制限, 最大1レイヤー
**最適化結果**: 解法時間約12秒, 目的値744.99
**配置結果**: ベースレイヤーQWERTY-like, レイヤー1に矢印キー配置

#### 制限事項・課題

1. **アルファベット位置制限**: A-Zは固定位置（v2仕様通り、v3で解決予定）
2. **数字クラスタ未実装**: 新v1で実装予定
3. **パフォーマンス**: 48,000+変数で解法時間が長い

#### 次のステップ

- Phase A完了: v2実装の整理・文書化 ✓
- Phase B開始: v1専用ソルバー設計
- Phase C: 指別Fitts係数実装
- Phase D: 数字クラスタ実装

### 実装参照

- 実装コード: `crates/analyzer/src/optimize/v2/`
- 設定例: `config/v2_sample.toml`, `config/phase3_test.toml`
- 結果可視化: `figs/optimized_layers_rowstagger_*.png`

## 関連リソース

### 理論的背景
- Fitts, P. M. (1954). The information capacity of the human motor system
- Card, S. K., English, W. K., & Burr, B. J. (1978). Evaluation of mouse, rate-controlled isometric joystick, step keys, and text keys for text selection on a CRT

### 実装リファレンス
- [COIN-OR CBC](https://www.coin-or.org/Cbc/)
- [SCIP Optimization Suite](https://scip.zib.de/)
- [Gurobi Optimizer](https://www.gurobi.com/)

## 変更履歴

### v2.0 (最新)
- v1の全機能を継承
- レイヤ機能の追加
- 同時押し時間の精密モデル
- 物理配置とレイヤ割当の分離設計

### v1.0 (基盤版)
- 指別Fitts係数による精密モデル
- 方向依存の有効幅計算
- 矢印・数字クラスタの連結制約
- 前計算による完全線形化

## 貢献とフィードバック

このモデルの改善や新機能の提案については、プロジェクトのIssueやPull Requestでお知らせください。特に以下の分野でのフィードバックを歓迎します：

- パフォーマンス改善
- 新しい制約の追加
- より精密なFittsモデル
- 実用例での検証結果

## ライセンス

このドキュメントとモデルは、プロジェクトのライセンスに従って利用できます。