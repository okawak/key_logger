# キーボード配列最適化モデル v1: 詳細仕様書

## 概要

キーボードのログデータから、Fittsの法則に基づいて最適なキーボード配列を求める混合整数線形計画問題として定式化する。v1では、アルファベット（A-Z）を固定位置として、記号・矢印・数字キーの配置を最適化する。

## 1. 基本記号と集合の定義

### 1.1 幾何学的要素

#### 座標系の定義
- **行の集合**: $R = \{0, 1, 2, \ldots, R_{\max}\}$
  - 下の行から0とする（例：下から0行目、1行目、2行目...）
  - 各キーの縦幅は1uで固定
  - 行$r$の中心$y$座標: $y_r$ [mm]

- **列方向のセル格子**: $J = \{0, 1, 2, \ldots, C - 1\}$
  - 0.25u単位での左からの位置を表す
  - セル$j$は0.25u幅の基本単位
  - 1u = 4セル相当

#### キー幅の定義
- **可能な横幅の集合**: $S = \{4, 5, 6, \ldots, 12\}$
  - 1u（=4セル）から3u（=12セル）まで
  - 0.25u刻みでサイズを指定
  - **基本セルサイズ**: $s_0 = 4$ (1u相当)

#### 座標変換係数
- **uからmmの変換係数**: $d_{\mathrm{mm}} = 19.05$ mm/u (標準的な値)
- **セルからmmへの変換係数**: $\Delta_{\mathrm{mm}} = d_{\mathrm{mm}}/4 = 4.7625$ mm/cell

### 1.2 キー関連集合

#### キーの分類
- **最適化対象キーの集合**: $K$
  - 記号キー（!など）
  - 機能キー（Tab, Esc, Shift, Enter等）
  - その他の特殊キー

- **矢印キー集合**: $A = \{\uparrow, \downarrow, \leftarrow, \rightarrow\}$
  - 専用の配置ルールが適用される
  - 横一列またはT字型配置

- **固定アルファベット**: $\mathcal{A} = \{A, B, C, \ldots, Z\}$
  - QWERTY等の既存配列で固定
  - 最適化対象外

#### 頻度データ
- **頻度（確率）**: $p_k$ $(k \in K \cup A)$
  - キーロガーから得られたキー使用頻度
  - 正規化されて $\sum_{k \in K \cup A} p_k = 1$

### 1.3 配置制約と指の割り当て

#### 既存の制約
- **占有セル**: $O_{rj} \in \{0, 1\}$
  - 既に固定キーが占有しているセルを表す
  - $O_{rj} = 1$ の場合、セル$(r,j)$は利用不可

#### 指の割り当て
- **セル$(r, j)$を担当する指**: $f(r, j) \in \{\text{左小指}, \text{左薬指}, \ldots, \text{右小指}\}$
  - 各セルに対して担当指が事前に決められている
  - キーボード配列（row-staggered等）に依存

- **ホームポジションの座標**: $h_f = (x_f, y_f)$ [mm]
  - 各指$f$のホームポジション
  - Fitts時間計算の起点となる

## 2. Fitts時間モデルの詳細

### 2.1 座標計算

#### キー中心座標の計算
候補$(r, i, s)$について：
- **開始セル**: $i$ （0.25u単位での左端位置）
- **幅**: $s$ （セル単位）
- **中心座標**:
  $$x = \left(i + \frac{s}{2}\right) \Delta_{\mathrm{mm}}$$
  $$y = y_r$$

### 2.2 方向依存の有効幅（楕円近似）

#### 移動角度の計算
$$\theta = \arctan2(y - y_f, x - x_f)$$

#### 楕円パラメータ
- **横半径**: $a = s \Delta_{\mathrm{mm}} / 2$ （キー幅の半分）
- **縦半径**: $b = d_{\mathrm{mm}} / 2$ （固定1uの半分）

#### 有効幅の計算
$$W_{\mathrm{eff}} = \frac{1}{\sqrt{\frac{\cos^2\theta}{a^2} + \frac{\sin^2\theta}{b^2}}}$$

この式により、移動方向に応じてキーの有効的な「狙いやすさ」が変化する：
- 水平移動（$\theta = 0°, 180°$）: 横幅が重要
- 垂直移動（$\theta = 90°, 270°$）: 縦幅が重要

### 2.3 指別Fitts係数と時間計算

#### 指別パラメータ
各指$f$に対して：
- **切片係数**: $a_f$ [ms] （指の反応時間）
- **傾き係数**: $b_f$ [ms] （指の運動能力）

一般的に：$a_{\text{人差指}} < a_{\text{中指}} < a_{\text{薬指}} < a_{\text{小指}}$

#### 距離の計算
$$D = \sqrt{(x - x_f)^2 + (y - y_f)^2}$$

#### Fitts時間の計算
担当指 $f = f(r, i + \lfloor s/2 \rfloor)$ に対して：
$$T(r, i, s) = a_f + b_f \log_2\left(\frac{D}{W_{\mathrm{eff}}} + 1\right)$$

**重要な性質**:
- $T(r, i, s)$は特定のキーに依存しない
- $(r, i, s)$の組み合わせのみで決まる
- 事前計算して定数として扱える

## 3. 候補集合の詳細定義

### 3.1 通常キー候補集合

$$\mathcal{C} = \{(r, i, s) \mid r \in R, s \in S, 0 \leq i \leq C - s, \text{空間制約満足}\}$$

**空間制約**:
$$O_{rj} = 0 \quad \forall j \in [i, i + s - 1]$$

これは、幅$s$のキーを位置$i$から配置する際に、占有する全セル$[i, i+s-1]$が空いていることを要求する。

### 3.2 矢印キー配置候補

矢印キーは連結したクラスタとして配置され、2つの配置パターンが可能：

#### 3.2.1 横一列配置
$$\Omega_H = \{(r, i) \mid r \in R, 0 \leq i \leq C - 4s_0, \text{連続空間確保}\}$$

**連続空間確保条件**:
$$O_{rj} = 0 \quad \forall j \in [i, i + 4s_0 - 1]$$

配置順序: $\leftarrow \downarrow \uparrow \rightarrow$ （位置 $i, i+s_0, i+2s_0, i+3s_0$）

#### 3.2.2 T字型配置
$$\Omega_T = \{(r, i) \mid r + 1 \leq R_{\max}, 0 \leq i \leq C - 3s_0, \text{T字空間確保}\}$$

**T字空間確保条件**:
- 下段（行$r$）: $O_{rj} = 0 \quad \forall j \in [i, i + 3s_0 - 1]$
- 上段（行$r+1$）: $O_{(r+1)j} = 0 \quad \forall j \in [i+s_0, i+2s_0-1]$

配置：
```
  ↑
← ↓ →
```
- 下段: $\leftarrow$ (位置$i$), $\downarrow$ (位置$i+s_0$), $\rightarrow$ (位置$i+2s_0$)
- 上段: $\uparrow$ (位置$i+s_0$)

## 4. 決定変数の詳細

### 4.1 通常キー配置変数
$$x_{k,r,i,s} \in \{0,1\} \quad (k \in K, (r,i,s) \in \mathcal{C})$$

**解釈**:
- $x_{k,r,i,s} = 1$: キー$k$を行$r$、開始位置$i$、幅$s$で配置
- $x_{k,r,i,s} = 0$: その配置を使用しない

### 4.2 矢印キー配置変数

#### 横一列配置
$$z^H_{r,i} \in \{0,1\} \quad ((r,i) \in \Omega_H)$$

#### T字型配置
$$z^T_{r,i} \in \{0,1\} \quad ((r,i) \in \Omega_T)$$

**重要**: 矢印キーは4つまとめて1つの配置単位として扱われる

## 5. 目的関数の詳細

### 5.1 期待Fitts時間の最小化

$$\min \left( \text{通常キー時間} + \text{矢印キー時間} \right)$$

### 5.2 通常キー時間
$$\sum_{k \in K} \sum_{(r,i,s) \in \mathcal{C}} p_k T(r,i,s) x_{k,r,i,s}$$

### 5.3 矢印キー時間

#### 横一列配置の場合
$$\sum_{(r,i) \in \Omega_H} \left[\sum_{m=0}^3 p_{a_m} T(r, i + ms_0, s_0)\right] z^H_{r,i}$$

ここで $a_m$ は $m$ 番目の矢印キー：
- $a_0 = \leftarrow$, $a_1 = \downarrow$, $a_2 = \uparrow$, $a_3 = \rightarrow$

#### T字型配置の場合
$$\sum_{(r,i) \in \Omega_T} \left[
p_{\leftarrow}T(r,i,s_0) + p_{\downarrow}T(r,i+s_0,s_0) + p_{\rightarrow}T(r,i+2s_0,s_0) + p_{\uparrow}T(r+1,i+s_0,s_0)
\right] z^T_{r,i}$$

## 6. 制約条件の詳細

### 6.1 一意性制約

各キーは必ず1つの位置に配置される：
$$\sum_{(r,i,s) \in \mathcal{C}} x_{k,r,i,s} = 1 \quad \forall k \in K$$

### 6.2 矢印配置の一意性

矢印キーは横一列またはT字型のいずれか1つの配置を選択：
$$\sum_{(r,i) \in \Omega_H} z^H_{r,i} + \sum_{(r,i) \in \Omega_T} z^T_{r,i} = 1$$

### 6.3 物理的非重複制約

各セルは最大1つのキーのみが占有可能：
$$\sum_{k \in K} \sum_{\substack{(r,i,s) \in \mathcal{C} \\ i \leq j \leq i+s-1}} x_{k,r,i,s} + \phi^{\mathrm{arrow}}_{rj} + O_{rj} \leq 1 \quad \forall r \in R, \forall j \in J$$

### 6.4 矢印占有関数の詳細

指示関数 $\mathbf{1}_{[\alpha,\beta]}(j)$ を定義：
$$\mathbf{1}_{[\alpha,\beta]}(j) = \begin{cases}
1 & \text{if } j \in [\alpha, \beta] \\
0 & \text{otherwise}
\end{cases}$$

#### 矢印占有の合成
$$\phi^{\mathrm{arrow}}_{rj} = \phi^H_{rj} + \phi^{T,\mathrm{down}}_{rj} + \phi^{T,\mathrm{up}}_{rj}$$

#### 横一列占有
$$\phi^H_{rj} = \sum_{(r,i) \in \Omega_H} \sum_{m=0}^3 \mathbf{1}_{[i+ms_0, i+(m+1)s_0-1]}(j) z^H_{r,i}$$

#### T字型下段占有
$$\phi^{T,\mathrm{down}}_{rj} = \sum_{(r,i) \in \Omega_T} \sum_{m=0}^2 \mathbf{1}_{[i+ms_0, i+(m+1)s_0-1]}(j) z^T_{r,i}$$

#### T字型上段占有
$$\phi^{T,\mathrm{up}}_{rj} = \sum_{\substack{(r,i) \in \Omega_T \\ r \geq 1}} \mathbf{1}_{[i+s_0, i+2s_0-1]}(j) z^T_{r-1,i}$$

## 7. 問題の性質と解法

### 7.1 問題クラス
**混合整数線形計画問題（MILP）**
- 決定変数: 全て0-1整数変数
- 目的関数: 線形（事前計算されたFitts時間は定数）
- 制約条件: 全て線形

### 7.2 計算複雑度

#### 変数数の見積もり
- 通常キー変数: $|K| \times |\mathcal{C}|$
- 矢印キー変数: $|\Omega_H| + |\Omega_T|$
- 典型的なサイズ: 数千〜数万変数

#### 制約数の見積もり
- 一意性制約: $|K| + 1$
- 非重複制約: $|R| \times |J|$
- 典型的なサイズ: 数百〜数千制約

### 7.3 解法アルゴリズム

#### 厳密解法
1. **分枝限定法** (Branch and Bound)
2. **商用ソルバー**: Gurobi, CPLEX
3. **オープンソース**: HiGHS, CBC, SCIP

#### 前処理技術
1. **変数削減**: 明らかに劣位な配置の除去
2. **制約強化**: カット平面の追加
3. **対称性の破綻**: 同等解の除去

## 8. パラメータ設定例

### 8.1 物理パラメータ
- **距離変換**: $d_{\mathrm{mm}} = 19.05$ mm/u
- **行間隔**: 19.05 mm (row-staggeredの場合)

### 8.2 指別Fitts係数（例）
| 指 | $a_f$ [ms] | $b_f$ [ms] |
|---|---|---|
| 人差指 | 40 | 120 |
| 中指 | 45 | 130 |
| 薬指 | 55 | 145 |
| 小指 | 65 | 160 |

### 8.3 キー幅制約（例）
- 通常記号: $W_k = \{4, 5, 6\}$ (1u〜1.5u)
- Shift/Enter: $W_k = \{6, 8, 10\}$ (1.5u〜2.5u)
- Space: $W_k = \{12, 16, 20\}$ (3u〜5u)

## 9. 実装上の注意点

### 9.1 数値の安定性
- Fitts時間の事前計算時に数値誤差に注意
- 対数項で $D/W \to 0$ の場合の処理

### 9.2 スケーリング
- 目的関数値のスケールを適切に調整
- 制約の係数が大きくなりすぎないよう注意

### 9.3 モデルの検証
- 簡単なケースでの解の妥当性確認
- 制約の充足性チェック
- 最適解の実用性評価

## 10. 拡張の方向性

### 10.1 v2への拡張準備
- レイヤ機能の追加準備
- モディファイアキーの概念導入
- 同時押し時間モデルの検討

### 10.2 数字キーの扱い
- 数字キーも連結クラスタとして扱う可能性
- 0-9の順序制約の導入

### 10.3 学習コストの考慮
- 現在の配列からの変更コスト
- ユーザーの慣れ親しんだ配置の重み付け
