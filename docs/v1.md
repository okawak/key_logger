# キーボード配列最適化 - 数理モデル v1

## 概要

モデルv1は、**単一レイヤー・アルファベット固定**での最適化を扱います。記号キー・矢印・数字の配置を最適化し、アルファベット（A-Z）は固定位置（QWERTY等）に維持します。指別Fitts係数、方向依存幅、連結クラスタ対応など高度な機能を含む実用的なモデルです。

**主要特徴**:
- 記号キー・Tab/Esc/Shift等の最適配置
- 矢印キーと数字キーの連結クラスタ
- 指別Fitts係数による精密なタイピング時間モデル
- 方向依存の有効幅計算（楕円近似）
- 前計算による完全線形化

## 1. 幾何と集合の定義

### 1.1 基本集合

- **配列集合**: $G = \{\text{row-staggered, column-staggered, ortholinear}\}$
- **行の集合** ($g \in G$): $R_g$
- **セル格子**: $J_g = \{(r,c) \mid r \in R_g, c \in \mathbb{Z}\}$ (横0.25u刻み)
- **1uブロック集合**: $\mathcal{U}_g$ (0.25u×4のブロック)
- **近傍グラフ**: $E_g \subset \mathcal{U}_g \times \mathcal{U}_g$ (4近傍等)

### 1.2 キー集合の分類

- **固定アルファベット**: $\mathcal{A} = \{A, B, \ldots, Z\}$ (配置固定)
- **最適化対象キー**: $K$ (記号・Tab/Esc/Shift等)
- **矢印キー**: $A = \{\uparrow, \downarrow, \leftarrow, \rightarrow\}$
- **数字キー**: $N = \{1, 2, \ldots, 9, 0\}$

### 1.3 幾何パラメータ

- **指割当**: $F(r,c)$、ブロック担当指 $F(u)$
- **指ホーム**: $h_f^g$ (指$f$のホームポジション)
- **mm変換**: $s_{\mathrm{u2mm}} = 19$ mm/u
- **許可幅集合**: $W_k$ (キー$k$の許可幅、0.25u単位)
- **配置可能領域**: $\mathcal{I}_k^g \subseteq J_g$ (キー$k$の開始セル候補)

### 1.4 幾何学的関数

- **被覆関数**: $C(j', j, w) = \mathbf{1}[\text{セル}j'\text{が幅}w\text{のキーに覆われる}]$
- **ブロック被覆**: $B(j', u) = \mathbf{1}[\text{ブロック}u\text{がセル}j'\text{を覆う}]$
- **固定占有**: $F^g_{j'} = \mathbf{1}[\text{セル}j'\text{が固定キーで占有}]$

## 2. Fitts時間の前計算

### 2.1 方向依存の有効幅（楕円近似）

キー横幅 $w$（u単位）、縦 $h=1$、移動方向角 $\phi$：
$$W_{\mathrm{eff}}(w,h,\phi) = \frac{1}{\sqrt{\frac{\cos^2\phi}{w^2} + \frac{\sin^2\phi}{h^2}}}$$

### 2.2 指別Fitts係数

各指 $f$ に固有の係数 $(a_f, b_f)$ を設定。候補中心 $\mathbf{x}$、担当指 $f$に対して：
$$D = s_{\mathrm{u2mm}} \|\mathbf{x} - h_f^g\|_2$$
$$W = s_{\mathrm{u2mm}} W_{\mathrm{eff}}(w, 1, \phi)$$
$$T_{\mathrm{tap}} = a_f + b_f \log_2\left(\frac{D}{W} + 1\right)$$

**端狙い補正**（任意）: $D^* = \max(0, D - \eta W)$ で $D^*/W$ に置換 ($\eta \in [0, 0.5]$)

### 2.3 事前計算による定数化

全候補について**事前計算して定数化**:
- $T^{(k)}_{j,w}$: 通常キー$k$の候補$(j,w)$のタップ時間
- $T_{\mathrm{tap}}(u)$: ブロック$u$のタップ時間

## 3. v1の決定変数

### 3.1 通常キー配置

$$x_{k,j,w} \in \{0,1\} \quad (k \in K, j \in \mathcal{I}_k^g, w \in W_k)$$

ここで、$\mathcal{I}^g_k \subseteq J_g$はキー$k$が配置可能な開始セルの集合。

- $x_{k,j,w} = 1$: キー$k$を開始セル$j$に幅$w$で配置
- $x_{k,j,w} = 0$: それ以外

### 3.2 連結クラスタ（矢印・数字共通スキーム）

対象集合 $D$、サイズ $S_D$ とする（矢印: $S_A=4$、数字: $S_N=10$）

**使用フラグ・ラベル・根・フロー**:
$$a^D_u \in \{0,1\}, \quad m^D_{d,u} \in \{0,1\} \, (d \in D), \quad r^D_u \in \{0,1\}, \quad f^D_{u \to v} \geq 0$$

- $a^D_u = 1$: ブロック$u$が集合$D$のいずれかの要素で使用される
- $m^D_{d,u} = 1$: 要素$d \in D$がブロック$u$に配置される  
- $r^D_u = 1$: ブロック$u$が連結クラスタの根となる
- $f^D_{u \to v}$: ブロック$u$から$v$へのフロー量

## 4. v1の目的関数

頻度 $f_k, f_d$（正規化推奨）、重み $\alpha, \beta$、正則化 $\lambda_w$：
$$\min \left[
\alpha \sum_{k \in K} \sum_{j,w} f_k T^{(k)}_{j,w} x_{k,j,w}
+ \beta \sum_{d \in A} \sum_{u} f_d T_{\mathrm{tap}}(u) m^A_{d,u}
+ \beta \sum_{d \in N} \sum_{u} f_d T_{\mathrm{tap}}(u) m^N_{d,u}
+ \lambda_w \sum_{k,j,w} w x_{k,j,w}
\right]$$

**目的関数の構成要素**:
1. **通常キータップコスト**: 使用頻度 × 指別Fitts時間
2. **矢印キータップコスト**: 矢印使用頻度 × Fitts時間  
3. **数字キータップコスト**: 数字使用頻度 × Fitts時間
4. **幅正則化**: キー幅に対するペナルティ（オプション）

## 5. v1の制約条件

### 5.1 一意性制約

$$\sum_{j,w} x_{k,j,w} = 1 \quad \forall k \in K$$

### 5.2 物理非重複制約

$$\sum_{k \in K} \sum_{j,w} C(j',j,w) x_{k,j,w} + \sum_{u} B(j',u) a^A_u + \sum_{u} B(j',u) a^N_u + F^g_{j'} \leq 1 \quad \forall j' \in J_g$$

### 5.3 連結クラスタ制約（矢印・数字共通）

**個数と割当**:
$$\sum_{u} a^A_u = 4, \quad \sum_{u} a^N_u = 10$$
$$\sum_{u} m^D_{d,u} = 1 \quad \forall d \in D, \quad m^D_{d,u} \leq a^D_u$$

**連結（根+フロー）**:
$$\sum_{v} f^D_{v \to u} - \sum_{v} f^D_{u \to v} = a^D_u - S_D r^D_u \quad \forall u$$
$$\sum_{u} r^D_u = 1$$
$$0 \leq f^D_{u \to v} \leq (S_D-1) a^D_u, \quad 0 \leq f^D_{u \to v} \leq (S_D-1) a^D_v \quad \forall (u,v) \in E_g$$

### 5.4 変数の定義域

$$x_{k,j,w} \in \{0,1\}, \quad a^D_u \in \{0,1\}, \quad m^D_{d,u} \in \{0,1\}, \quad r^D_u \in \{0,1\}, \quad f^D_{u \to v} \geq 0$$

## 6. v1の完全な定式化

### 6.1 目的関数
$$\min \left[
\alpha \sum_{k \in K} \sum_{j \in \mathcal{I}_k^g} \sum_{w \in W_k} f_k T^{(k)}_{j,w} x_{k,j,w}
+ \beta \sum_{d \in A} \sum_{u \in \mathcal{U}_g} f_d T_{\mathrm{tap}}(u) m^A_{d,u}
+ \beta \sum_{d \in N} \sum_{u \in \mathcal{U}_g} f_d T_{\mathrm{tap}}(u) m^N_{d,u}
+ \lambda_w \sum_{k \in K} \sum_{j,w} w x_{k,j,w}
\right]$$

### 6.2 制約条件

#### (1) 通常キーの一意性
$$\sum_{j \in \mathcal{I}_k^g} \sum_{w \in W_k} x_{k,j,w} = 1 \quad \forall k \in K$$

#### (2) 物理非重複制約
$$\sum_{k \in K} \sum_{j,w} C(j',j,w) x_{k,j,w} + \sum_{u} B(j',u) a^A_u + \sum_{u} B(j',u) a^N_u + F^g_{j'} \leq 1 \quad \forall j' \in J_g$$

#### (3) 矢印クラスタ制約
$$\sum_{u} a^A_u = 4, \quad \sum_{u} m^A_{d,u} = 1 \, \forall d \in A, \quad m^A_{d,u} \leq a^A_u$$
$$\sum_{v} f^A_{v \to u} - \sum_{v} f^A_{u \to v} = a^A_u - 4r^A_u \, \forall u, \quad \sum_{u} r^A_u = 1$$
$$0 \leq f^A_{u \to v} \leq 3a^A_u, \quad 0 \leq f^A_{u \to v} \leq 3a^A_v \, \forall (u,v) \in E_g$$

#### (4) 数字クラスタ制約（矢印と同構造、$S_N=10$）
$$\sum_{u} a^N_u = 10, \quad \sum_{u} m^N_{d,u} = 1 \, \forall d \in N, \quad m^N_{d,u} \leq a^N_u$$
$$\sum_{v} f^N_{v \to u} - \sum_{v} f^N_{u \to v} = a^N_u - 10r^N_u \, \forall u, \quad \sum_{u} r^N_u = 1$$
$$0 \leq f^N_{u \to v} \leq 9a^N_u, \quad 0 \leq f^N_{u \to v} \leq 9a^N_v \, \forall (u,v) \in E_g$$

#### (5) 変数の定義域
$$x_{k,j,w} \in \{0,1\}, \quad a^D_u \in \{0,1\}, \quad m^D_{d,u} \in \{0,1\}, \quad r^D_u \in \{0,1\}, \quad f^D_{u \to v} \geq 0$$

## 7. パラメータ設定

### 7.1 物理パラメータ

- **距離変換**: $s_{\mathrm{u2mm}} = 19$ mm/u
- **端狙い補正**: $\eta = 0$ (必要に応じ 0.25-0.5)

### 7.2 指別Fittsパラメータ（例）

- 人差指: $a = 40$ ms, $b = 120$ ms
- 中指: $a = 45$ ms, $b = 130$ ms
- 薬指: $a = 55$ ms, $b = 145$ ms
- 小指: $a = 65$ ms, $b = 160$ ms
- 親指: $a = 50$ ms, $b = 140$ ms

### 7.3 最適化パラメータ

- **重み**: $\alpha = 1.0$（通常キー）, $\beta = 1.0$（矢印・数字）
- **正則化**: $\lambda_w = 0 \sim 0.05$

### 7.4 座標系定義

**Row-staggered (標準QWERTY)**:
- 行間隔: 19.05mm (0.75インチ)
- 列間隔: 19.05mm (0.75インチ)
- 行オフセット: [0, 6.35mm, 9.525mm, ...] (段差)

**Column-staggered**:
- 列間隔: 19.05mm
- 列オフセット: 指の長さに応じた調整

**Ortholinear**:
- 格子状配置: 19.05mm × 19.05mm

## 8. 問題の複雑性

### 8.1 変数数の計算

**v1**:
- 通常キー: $|K| \times |\mathcal{I}^g| \times |W|$
- 矢印・数字クラスタ: $(18 + 2|E_g|)|\mathcal{U}_g|$

### 8.2 制約数の計算

**v1**:
- 一意性・個数: $|K| + 14$
- 物理制約: $|J_g|$
- 連結制約: $4|\mathcal{U}_g| + 4 + 4|E_g|$

### 8.3 問題クラス

**混合整数線形計画問題（MILP）**であり、CBCなどのオープンソースソルバーで解くことができます。

## 9. 解法アルゴリズム

### 9.1 厳密解法

1. **分枝限定法** (Branch and Bound)
2. **カッティングプレーン法**
3. **商用ソルバー**: Gurobi, CPLEX
4. **オープンソース**: CBC, SCIP

### 9.2 近似解法

1. **遺伝的アルゴリズム**
2. **シミュレーテッドアニーリング**
3. **貪欲法** + 局所探索

### 9.3 前処理技術

1. **変数削減**: 明らかに劣位な配置の除去
2. **制約強化**: 有効不等式の追加
3. **分解手法**: 部分問題への分割

## 10. モデルv1の特徴

### 10.1 主要改善（新方針）

1. **指別Fitts係数**: 各指の特性を考慮した精密なモデル
2. **方向依存有効幅**: 楕円近似による現実的な幅計算
3. **数字クラスタ**: 矢印と同様の連結制約で数字を一体配置
4. **完全線形化**: すべての係数を事前計算して定数化
5. **統一スキーム**: 矢印・数字クラスタの共通定式化

### 10.2 設計思想

- **単一レイヤー**: レイヤ機能なしでのシンプルな最適化
- **アルファベット固定**: A-Zは既存配列（QWERTY等）に固定
- **実用性**: 実際のキーボード製作で使用可能な制約設定
- **拡張基盤**: v2（複数レイヤー）への自然な拡張が可能

## 11. まとめ

モデルv1は、単一レイヤーでのキーボード配列最適化のための包括的な数理モデルです。指別Fitts係数、方向依存有効幅、数字クラスタなど高度な機能を含みながら、レイヤ機能を含まないシンプルな構造により理解しやすく、v2への基盤となる重要なモデルです。前計算による完全線形化により、大規模問題でも効率的に解けるよう設計されており、CBCなどのオープンソースソルバーで実行可能です。